<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銀河系探索アプリ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: #000;
            color: #fff;
            overflow: hidden;
            cursor: crosshair;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }
        
        #info h1 {
            color: #00ffff;
            font-size: 18px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
        }
        
        #info p {
            font-size: 12px;
            color: #ccc;
            line-height: 1.4;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ffff;
            backdrop-filter: blur(5px);
        }
        
        #controls h3 {
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        #controls p {
            font-size: 11px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        #modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #001122 0%, #003366 100%);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid #00ffff;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .close {
            color: #00ffff;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close:hover {
            color: #ffffff;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .modal-header h2 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 0 0 15px #00ffff;
        }
        
        .modal-body {
            color: #ccc;
            line-height: 1.6;
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        .modal-text {
            flex: 1;
        }
        
        .modal-3d {
            flex: 0 0 250px;
            height: 250px;
            border: 2px solid #00ffff;
            border-radius: 10px;
            background: #000011;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-3d canvas {
            border-radius: 8px;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .celestial-image {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            border-radius: 8px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            animation: planetRotate 20s linear infinite;
            transform-origin: center center;
            filter: brightness(1.1) contrast(1.1) saturate(1.2);
            transition: all 0.3s ease;
        }
        
        .celestial-image:hover {
            transform: scale(1.05);
            filter: brightness(1.3) contrast(1.2) saturate(1.4);
        }
        
        .celestial-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 255, 0.8);
            border: 1px solid #00ffff;
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            z-index: 20;
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
        }
        
        .celestial-toggle:hover {
            background: rgba(0, 255, 255, 1);
            transform: scale(1.05);
        }
        
        .planet-label {
            position: absolute;
            background: rgba(0, 255, 255, 0.9);
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            pointer-events: none;
            z-index: 200;
            backdrop-filter: blur(3px);
            border: 1px solid #00ffff;
            display: none;
            animation: labelFadeIn 0.3s ease-out;
            text-shadow: none;
        }
        
        @keyframes labelFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes planetRotate {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.02); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.02); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .sun-image {
            animation: sunPulse 3s ease-in-out infinite alternate !important;
        }
        
        @keyframes sunPulse {
            0% { 
                transform: rotate(0deg) scale(1);
                filter: brightness(1.2) contrast(1.1) saturate(1.3) drop-shadow(0 0 20px #ffff00);
            }
            100% { 
                transform: rotate(360deg) scale(1.05);
                filter: brightness(1.5) contrast(1.3) saturate(1.5) drop-shadow(0 0 30px #ffaa00);
            }
        }
        
        .earth-image {
            animation: earthRotate 15s linear infinite, earthGlow 4s ease-in-out infinite alternate !important;
        }
        
        @keyframes earthRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes earthGlow {
            0% { 
                filter: brightness(1.1) contrast(1.1) saturate(1.3) drop-shadow(0 0 15px #4a90e2);
            }
            100% { 
                filter: brightness(1.3) contrast(1.2) saturate(1.4) drop-shadow(0 0 25px #6bb6ff);
            }
        }
        
        .saturn-image {
            animation: saturnWobble 8s ease-in-out infinite !important;
        }
        
        @keyframes saturnWobble {
            0%, 100% { 
                transform: rotate(0deg) scale(1);
                filter: brightness(1.1) contrast(1.1) saturate(1.2);
            }
            25% { 
                transform: rotate(5deg) scale(1.02);
                filter: brightness(1.2) contrast(1.15) saturate(1.3);
            }
            50% { 
                transform: rotate(0deg) scale(1.01);
                filter: brightness(1.15) contrast(1.12) saturate(1.25);
            }
            75% { 
                transform: rotate(-5deg) scale(1.02);
                filter: brightness(1.2) contrast(1.15) saturate(1.3);
            }
        }
        
        .gas-giant {
            animation: gasGiantSwirl 12s ease-in-out infinite !important;
        }
        
        @keyframes gasGiantSwirl {
            0% { 
                transform: rotate(0deg) scale(1);
                filter: brightness(1.1) contrast(1.1) saturate(1.2) hue-rotate(0deg);
            }
            33% { 
                transform: rotate(120deg) scale(1.03);
                filter: brightness(1.25) contrast(1.2) saturate(1.4) hue-rotate(10deg);
            }
            66% { 
                transform: rotate(240deg) scale(1.01);
                filter: brightness(1.15) contrast(1.15) saturate(1.3) hue-rotate(-10deg);
            }
            100% { 
                transform: rotate(360deg) scale(1);
                filter: brightness(1.1) contrast(1.1) saturate(1.2) hue-rotate(0deg);
            }
        }
        
        .rocky-planet {
            animation: rockyPlanetRotate 10s linear infinite, rockyGlow 6s ease-in-out infinite alternate !important;
        }
        
        @keyframes rockyPlanetRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes rockyGlow {
            0% { 
                filter: brightness(1.0) contrast(1.1) saturate(1.1);
            }
            100% { 
                filter: brightness(1.2) contrast(1.2) saturate(1.3);
            }
        }
        
        .moon-image {
            animation: moonPhases 8s ease-in-out infinite !important;
        }
        
        @keyframes moonPhases {
            0%, 100% { 
                transform: rotate(0deg) scale(1);
                filter: brightness(1.0) contrast(1.1) saturate(0.9);
            }
            25% { 
                transform: rotate(90deg) scale(1.02);
                filter: brightness(1.1) contrast(1.15) saturate(1.0);
            }
            50% { 
                transform: rotate(180deg) scale(1.01);
                filter: brightness(1.2) contrast(1.2) saturate(1.1);
            }
            75% { 
                transform: rotate(270deg) scale(1.02);
                filter: brightness(1.1) contrast(1.15) saturate(1.0);
            }
        }
        
        .modal-body h3 {
            color: #00aaff;
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        .fact-list {
            list-style: none;
            padding-left: 0;
        }
        
        .fact-list li {
            background: rgba(0, 255, 255, 0.1);
            margin: 8px 0;
            padding: 10px;
            border-left: 3px solid #00ffff;
            border-radius: 5px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #object-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #00ffff;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            border: 1px solid #00ffff;
            display: none;
            z-index: 200;
            backdrop-filter: blur(3px);
        }
        
        @media (max-width: 768px) {
            #info, #controls {
                display: none;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-spinner"></div>
        <p style="color: #00ffff;">銀河系を読み込み中...</p>
    </div>
    
    <div id="container"></div>
    
    <div id="info">
        <h1>🌌 銀河系探索アプリ</h1>
        <p>マウスで宇宙を探索し、<br>天体をクリックして詳細を確認しよう！</p>
    </div>
    
    <div id="controls">
        <h3>操作方法</h3>
        <p>🖱️ ドラッグ: 回転</p>
        <p>🎯 ホイール: ズーム</p>
        <p>👆 クリック: 天体詳細</p>
    </div>
    
    <div id="object-label"></div>
    <div id="planet-label" class="planet-label"></div>
    
    <div id="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 id="modal-title">天体名</h2>
            </div>
            <div class="modal-body">
                <div class="modal-text">
                    <div id="modal-content"></div>
                </div>
                <div class="modal-3d" id="modal-3d-container">
                    <img id="celestial-image" class="celestial-image" style="display: none;" alt="天体画像">
                    <button id="toggle-view" class="celestial-toggle">3D表示</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 天体データ
        const celestialBodies = [
            {
                name: "太陽",
                type: "恒星",
                radius: 10,
                distance: 0,
                color: 0xffff00,
                imageUrl: "https://images.unsplash.com/photo-1614642264762-908ec80756da?w=400",
                description: "太陽系の中心にある恒星で、地球に光と熱を提供している巨大な核融合炉です。",
                facts: [
                    "表面温度: 約5,778K (5,505°C)",
                    "質量: 地球の約333,000倍",
                    "直径: 地球の約109倍",
                    "年齢: 約46億年",
                    "組成: 水素73%、ヘリウム25%"
                ]
            },
            {
                name: "水星",
                type: "惑星",
                radius: 1.5,
                distance: 20,
                color: 0x8c7853,
                imageUrl: "https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=400",
                description: "太陽に最も近い惑星で、極端な温度差が特徴的な小さな岩石惑星です。",
                facts: [
                    "太陽からの距離: 約5,790万km",
                    "公転周期: 88日",
                    "自転周期: 59日",
                    "表面温度: -170°C〜430°C",
                    "大気: ほぼ真空状態"
                ]
            },
            {
                name: "金星",
                type: "惑星",
                radius: 2.3,
                distance: 30,
                color: 0xffc649,
                imageUrl: "https://images.unsplash.com/photo-1446776558166-79d2b5a625e2?w=400",
                description: "地球の「双子星」と呼ばれる惑星で、濃厚な大気による温室効果で非常に高温です。",
                facts: [
                    "太陽からの距離: 約1億800万km",
                    "公転周期: 225日",
                    "表面温度: 約460°C",
                    "大気圧: 地球の約90倍",
                    "逆回転する唯一の惑星"
                ]
            },
            {
                name: "地球",
                type: "惑星",
                radius: 2.5,
                distance: 42,
                color: 0x6b93d6,
                imageUrl: "https://images.unsplash.com/photo-1614730321146-b6fa6a46bcb4?w=400",
                description: "私たちの故郷である美しい青い惑星。生命が存在する唯一知られた天体です。",
                facts: [
                    "太陽からの距離: 約1億4,960万km",
                    "公転周期: 365.25日",
                    "表面の71%が海洋",
                    "大気組成: 窒素78%、酸素21%",
                    "唯一確認された生命存在惑星"
                ]
            },
            {
                name: "月",
                type: "衛星",
                radius: 0.8,
                distance: 47,
                color: 0xc0c0c0,
                imageUrl: "https://images.unsplash.com/photo-1446776877081-d282a0f896e2?w=400",
                description: "地球の唯一の天然衛星で、地球の潮汐や自転に大きな影響を与えています。",
                facts: [
                    "地球からの距離: 約38万km",
                    "直径: 地球の約1/4",
                    "公転周期: 約27.3日",
                    "同期回転（常に同じ面を地球に向ける）",
                    "アポロ計画で人類が到達"
                ]
            },
            {
                name: "火星",
                type: "惑星",
                radius: 2.0,
                distance: 60,
                color: 0xcd5c5c,
                imageUrl: "https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=400",
                description: "「赤い惑星」として知られ、将来の人類移住候補として注目される惑星です。",
                facts: [
                    "太陽からの距離: 約2億2,790万km",
                    "公転周期: 687日",
                    "1日: 24時間37分",
                    "極冠に氷が存在",
                    "太陽系最大の火山オリンポス山がある"
                ]
            },
            {
                name: "木星",
                type: "惑星",
                radius: 6.0,
                distance: 85,
                color: 0xffa500,
                imageUrl: "https://images.unsplash.com/photo-1614732414444-096e5f1122d5?w=400",
                description: "太陽系最大のガス惑星で、大赤斑と呼ばれる巨大な嵐が特徴的です。",
                facts: [
                    "太陽からの距離: 約7億7,830万km",
                    "質量: 地球の約318倍",
                    "衛星数: 95個以上",
                    "大赤斑: 地球2-3個分の大きさの嵐",
                    "主成分: 水素とヘリウム"
                ]
            },
            {
                name: "土星",
                type: "惑星",
                radius: 5.2,
                distance: 110,
                color: 0xffb347,
                imageUrl: "https://images.unsplash.com/photo-1446776708417-3aabf90b64be?w=400",
                description: "美しいリングで有名なガス惑星で、密度が水より低い唯一の惑星です。",
                facts: [
                    "太陽からの距離: 約14億2,700万km",
                    "密度: 0.687g/cm³（水より軽い）",
                    "リング: 氷と岩石の粒子で構成",
                    "衛星数: 146個以上",
                    "最大の衛星タイタンは大気を持つ"
                ]
            },
            {
                name: "天王星",
                type: "惑星",
                radius: 3.8,
                distance: 140,
                color: 0x40e0d0,
                imageUrl: "https://images.unsplash.com/photo-1446776877081-d282a0f896e2?w=400",
                description: "横倒しに回転する氷惑星で、メタンにより美しい青緑色を呈しています。",
                facts: [
                    "太陽からの距離: 約28億7,500万km",
                    "自転軸の傾き: 98度（横倒し）",
                    "公転周期: 84年",
                    "リング: 暗くて細い",
                    "大気: 水素、ヘリウム、メタン"
                ]
            },
            {
                name: "海王星",
                type: "惑星",
                radius: 3.6,
                distance: 170,
                color: 0x0066cc,
                imageUrl: "https://images.unsplash.com/photo-1446776558166-79d2b5a625e2?w=400",
                description: "太陽系最遠の惑星で、最も強い風が吹く美しい青い氷惑星です。",
                facts: [
                    "太陽からの距離: 約45億km",
                    "公転周期: 165年",
                    "風速: 最高2,100km/h",
                    "大暗斑: 木星の大赤斑に似た嵐",
                    "発見: 数学的予測により発見"
                ]
            }
        ];

        // Three.js セットアップ
        let scene, camera, renderer, controls;
        let celestialObjects = [];
        let raycaster, mouse;
        let selectedObject = null;
        let modalScene, modalCamera, modalRenderer;
        let twinklingStars = [];
        let starfield;
        
        // モーダル要素
        // モーダル要素（初期化を遅延させる）
        let modal, modalTitle, modalContent, modal3DContainer, celestialImage, toggleViewBtn, closeBtn, objectLabel, planetLabel;

        init();
        animate();

        function init() {
            // DOM要素を初期化
            initDOMElements();
            
            // シーンの作成
            scene = new THREE.Scene();
            
            // カメラの作成
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 100);

            // レンダラーの作成
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000011);
            document.getElementById('container').appendChild(renderer.domElement);

            // レイキャスターとマウスの初期化
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // 星空の背景を作成
            createStarfield();
            
            // 天体を作成
            createCelestialBodies();
            
            // OrbitControls （簡易実装）
            setupControls();
            
            // イベントリスナー
            setupEventListeners();
            
            // ローディングを非表示
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }, 2000);
        }
        
        function initDOMElements() {
            modal = document.getElementById('modal');
            modalTitle = document.getElementById('modal-title');
            modalContent = document.getElementById('modal-content');
            modal3DContainer = document.getElementById('modal-3d-container');
            celestialImage = document.getElementById('celestial-image');
            toggleViewBtn = document.getElementById('toggle-view');
            closeBtn = document.getElementsByClassName('close')[0];
            objectLabel = document.getElementById('object-label');
            planetLabel = document.getElementById('planet-label');
        }

        function createStarfield() {
            twinklingStars = []; // 配列を初期化
            
            // 基本の星空（静的）
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({ 
                color: 0xffffff, 
                size: 2,
                sizeAttenuation: false,
                transparent: true,
                opacity: 0.6
            });

            const starsVertices = [];
            for (let i = 0; i < 8000; i++) {
                const x = (Math.random() - 0.5) * 3000;
                const y = (Math.random() - 0.5) * 3000;
                const z = (Math.random() - 0.5) * 3000;
                starsVertices.push(x, y, z);
            }

            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            starfield = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(starfield);
            
            // 動的なキラキラ星
            createTwinklingStars();
        }
        
        function createTwinklingStars() {
            const colors = [
                0xffffff, // 白
                0x88ddff, // 青
                0xffaa44, // オレンジ
                0xff6666, // 赤
                0x66ff88, // 緑
                0xdd88ff, // 紫
                0xffff88, // 黄色
                0x88ffff  // シアン
            ];

            for (let i = 0; i < 800; i++) {
                const geometry = new THREE.SphereGeometry(0.15, 8, 8);
                const color = colors[Math.floor(Math.random() * colors.length)];
                const material = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.8
                });
                
                const star = new THREE.Mesh(geometry, material);
                star.position.set(
                    (Math.random() - 0.5) * 2500,
                    (Math.random() - 0.5) * 2500,
                    (Math.random() - 0.5) * 2500
                );
                
                // アニメーション用のプロパティ
                star.userData = {
                    baseColor: color,
                    twinkleSpeed: Math.random() * 3 + 1,
                    twinkleOffset: Math.random() * Math.PI * 2,
                    intensityVariation: Math.random() * 0.7 + 0.3,
                    pulseSpeed: Math.random() * 2 + 0.5
                };
                
                scene.add(star);
                twinklingStars.push(star);
            }
        }

        function createCelestialBodies() {
            // 軌道線を描画
            createOrbitLines();
            
            celestialBodies.forEach((bodyData) => {
                const geometry = new THREE.SphereGeometry(bodyData.radius, 32, 32);
                const material = new THREE.MeshBasicMaterial({ 
                    color: bodyData.color,
                    transparent: true
                });

                const celestialBody = new THREE.Mesh(geometry, material);
                
                // 位置を設定（太陽以外は軌道上に配置）
                if (bodyData.name === '太陽') {
                    celestialBody.position.set(0, 0, 0);
                    // 太陽の発光エフェクト
                    const glowGeometry = new THREE.SphereGeometry(bodyData.radius * 1.5, 32, 32);
                    const glowMaterial = new THREE.MeshBasicMaterial({
                        color: 0xffff00,
                        transparent: true,
                        opacity: 0.3
                    });
                    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                    celestialBody.add(glow);
                    
                    // 太陽光線エフェクト
                    createSunRays(celestialBody);
                } else if (bodyData.name === '月') {
                    // 地球の周りに配置
                    const earthPosition = celestialObjects.find(obj => obj.userData.name === '地球')?.position || { x: 42, y: 0, z: 0 };
                    celestialBody.position.set(earthPosition.x + 5, earthPosition.y, earthPosition.z);
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    celestialBody.position.set(
                        Math.cos(angle) * bodyData.distance,
                        (Math.random() - 0.5) * 5,
                        Math.sin(angle) * bodyData.distance
                    );
                }

                celestialBody.userData = bodyData;
                celestialObjects.push(celestialBody);
                scene.add(celestialBody);
            });

            // 土星のリングを追加
            const saturnRing = createSaturnRing();
            const saturn = celestialObjects.find(obj => obj.userData.name === '土星');
            if (saturn) {
                saturn.add(saturnRing);
            }
        }
        
        function createOrbitLines() {
            celestialBodies.forEach((bodyData) => {
                if (bodyData.distance > 0 && bodyData.name !== '月') {
                    const orbitGeometry = new THREE.RingGeometry(bodyData.distance - 0.2, bodyData.distance + 0.2, 64);
                    const orbitMaterial = new THREE.MeshBasicMaterial({
                        color: 0x444444,
                        transparent: true,
                        opacity: 0.3,
                        side: THREE.DoubleSide
                    });
                    const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                    orbit.rotation.x = Math.PI / 2;
                    scene.add(orbit);
                }
            });
        }
        
        function createSunRays(sunObject) {
            for (let i = 0; i < 8; i++) {
                const rayGeometry = new THREE.CylinderGeometry(0.1, 0.1, 50, 8);
                const rayMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffff00,
                    transparent: true,
                    opacity: 0.1
                });
                const ray = new THREE.Mesh(rayGeometry, rayMaterial);
                
                const angle = (i / 8) * Math.PI * 2;
                ray.position.set(Math.cos(angle) * 15, 0, Math.sin(angle) * 15);
                ray.rotation.z = angle + Math.PI / 2;
                
                sunObject.add(ray);
            }
        }

        function createSaturnRing() {
            const ringGeometry = new THREE.RingGeometry(7, 12, 32);
            const ringMaterial = new THREE.MeshBasicMaterial({
                color: 0xcccccc,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.x = Math.PI / 2;
            return ring;
        }

        function setupControls() {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            renderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            renderer.domElement.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaMove = {
                        x: e.clientX - previousMousePosition.x,
                        y: e.clientY - previousMousePosition.y
                    };

                    const rotationSpeed = 0.005;
                    camera.position.x = camera.position.x * Math.cos(deltaMove.x * rotationSpeed) - camera.position.z * Math.sin(deltaMove.x * rotationSpeed);
                    camera.position.z = camera.position.x * Math.sin(deltaMove.x * rotationSpeed) + camera.position.z * Math.cos(deltaMove.x * rotationSpeed);
                    
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                    camera.lookAt(scene.position);
                }
                
                // ホバー効果
                updateMousePosition(e);
                checkHover();
            });

            renderer.domElement.addEventListener('mouseup', () => {
                isDragging = false;
            });

            renderer.domElement.addEventListener('wheel', (e) => {
                const zoomSpeed = 0.1;
                camera.position.multiplyScalar(1 + e.deltaY * zoomSpeed * 0.001);
            });
        }

        function updateMousePosition(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function checkHover() {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(celestialObjects.filter(obj => obj.userData.name && obj.userData.distance !== undefined));

            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (object.userData.name) {
                    showObjectLabel(object.userData.name, event.clientX, event.clientY);
                    document.body.style.cursor = 'pointer';
                }
            } else {
                hideObjectLabel();
                document.body.style.cursor = 'crosshair';
            }
        }

        function showObjectLabel(name, x, y) {
            // PC版のラベル
            if (objectLabel) {
                objectLabel.textContent = name;
                objectLabel.style.left = x + 10 + 'px';
                objectLabel.style.top = y - 30 + 'px';
                objectLabel.style.display = 'block';
            }
            
            // モバイル版のラベル（常時表示）
            if (window.innerWidth <= 768 && planetLabel) {
                planetLabel.textContent = name;
                planetLabel.style.left = x + 10 + 'px';
                planetLabel.style.top = y - 30 + 'px';
                planetLabel.style.display = 'block';
                
                // 3秒後に自動で隠す
                setTimeout(() => {
                    if (planetLabel) planetLabel.style.display = 'none';
                }, 3000);
            }
        }

        function hideObjectLabel() {
            if (objectLabel) objectLabel.style.display = 'none';
            if (window.innerWidth > 768 && planetLabel) planetLabel.style.display = 'none';
        }

        function setupEventListeners() {
            // クリックイベント
            renderer.domElement.addEventListener('click', onObjectClick);
            
            // モーダルイベント（要素が存在する場合のみ）
            if (closeBtn) {
                closeBtn.onclick = () => {
                    if (modal) modal.style.display = 'none';
                };
            }
            
            window.onclick = (event) => {
                if (modal && event.target === modal) {
                    modal.style.display = 'none';
                }
            };

            // リサイズイベント
            window.addEventListener('resize', onWindowResize);
        }

        function onObjectClick(event) {
            updateMousePosition(event);
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(celestialObjects.filter(obj => obj.userData.name && obj.userData.distance !== undefined));
            
            if (intersects.length > 0) {
                const selectedObj = intersects[0].object;
                showModal(selectedObj.userData);
            }
        }

        function showModal(bodyData) {
            if (!modal || !modalTitle || !modalContent) return;
            
            modalTitle.textContent = `${bodyData.name} (${bodyData.type})`;
            
            let content = `
                <p>${bodyData.description}</p>
                <h3>基本データ</h3>
                <ul class="fact-list">
            `;
            
            bodyData.facts.forEach(fact => {
                content += `<li>${fact}</li>`;
            });
            
            content += '</ul>';
            modalContent.innerHTML = content;
            
            // 3Dモデルを作成
            create3DModal(bodyData);
            
            modal.style.display = 'block';
        }
        
        function create3DModal(bodyData) {
            if (!modal3DContainer || !celestialImage || !toggleViewBtn) return;
            
            let showingImage = true;
            
            // 天体画像を表示
            if (bodyData.imageUrl) {
                celestialImage.src = bodyData.imageUrl;
                celestialImage.alt = `${bodyData.name}の画像`;
                celestialImage.style.display = 'block';
                toggleViewBtn.textContent = '3D表示';
                
                celestialImage.onerror = function() {
                    // 画像読み込み失敗時は3Dに切り替え
                    showingImage = false;
                    this.style.display = 'none';
                    if (toggleViewBtn) toggleViewBtn.textContent = '画像表示';
                    create3DModelFallback(bodyData);
                };
            } else {
                // 画像がない場合は最初から3D表示
                showingImage = false;
                celestialImage.style.display = 'none';
                toggleViewBtn.textContent = '画像表示';
                create3DModelFallback(bodyData);
            }
            
            // 切り替えボタンのイベント
            toggleViewBtn.onclick = function() {
                if (showingImage) {
                    // 3Dに切り替え
                    if (celestialImage) celestialImage.style.display = 'none';
                    create3DModelFallback(bodyData);
                    this.textContent = '画像表示';
                    showingImage = false;
                } else {
                    // 画像に切り替え
                    clearCanvas();
                    if (bodyData.imageUrl && celestialImage) {
                        celestialImage.style.display = 'block';
                        this.textContent = '3D表示';
                        showingImage = true;
                    }
                }
            };
        }
        
        function clearCanvas() {
            if (!modal3DContainer) return;
            // 既存の3Dコンテンツをクリア
            const canvases = modal3DContainer.querySelectorAll('canvas');
            canvases.forEach(canvas => canvas.remove());
        }
        
        function create3DModelFallback(bodyData) {
            if (!modal3DContainer) return;
            
            // 既存のcanvasをクリア
            clearCanvas();
            
            // モーダル用の3Dシーンを作成
            modalScene = new THREE.Scene();
            modalCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            modalRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            modalRenderer.setSize(250, 250);
            modalRenderer.setClearColor(0x000011, 1);
            modal3DContainer.appendChild(modalRenderer.domElement);
            
            // 天体の3Dモデルを作成（メイン画面と同じスタイル）
            const geometry = new THREE.SphereGeometry(2, 32, 32);
            let material = new THREE.MeshBasicMaterial({ 
                color: bodyData.color,
                transparent: true
            });

            const modalPlanet = new THREE.Mesh(geometry, material);
            modalScene.add(modalPlanet);
            
            // 太陽の特別エフェクト
            if (bodyData.name === '太陽') {
                // 発光エフェクト（メイン画面と同じ）
                const glowGeometry = new THREE.SphereGeometry(2.5, 32, 32);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffff00,
                    transparent: true,
                    opacity: 0.3
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                modalScene.add(glow);
                
                // 太陽光線エフェクト（メイン画面と同じ）
                for (let i = 0; i < 8; i++) {
                    const rayGeometry = new THREE.CylinderGeometry(0.05, 0.05, 25, 8);
                    const rayMaterial = new THREE.MeshBasicMaterial({
                        color: 0xffff00,
                        transparent: true,
                        opacity: 0.1
                    });
                    const ray = new THREE.Mesh(rayGeometry, rayMaterial);
                    
                    const angle = (i / 8) * Math.PI * 2;
                    ray.position.set(Math.cos(angle) * 7.5, 0, Math.sin(angle) * 7.5);
                    ray.rotation.z = angle + Math.PI / 2;
                    
                    modalScene.add(ray);
                }
            }
            
            // 土星のリング（メイン画面と同じ）
            if (bodyData.name === '土星') {
                const ringGeometry = new THREE.RingGeometry(3, 4.5, 32);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0xcccccc,
                    transparent: true,
                    opacity: 0.6,
                    side: THREE.DoubleSide
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                modalPlanet.add(ring);
            }
            
            // 背景に星を追加（メイン画面の雰囲気に合わせて）
            addModalStarfield();
            
            // カメラの位置設定
            modalCamera.position.set(0, 1, 5);
            modalCamera.lookAt(modalScene.position);
            
            // アニメーションループ（メイン画面と同じ動き）
            let modalAnimationId;
            function animateModal() {
                if (modal && modal.style.display === 'block' && modalRenderer && modalRenderer.domElement.parentNode) {
                    modalAnimationId = requestAnimationFrame(animateModal);
                    
                    const time = Date.now() * 0.001;
                    
                    // 天体の回転（メイン画面と同じ）
                    if (bodyData.name === '太陽') {
                        modalPlanet.rotation.y += 0.005;
                        // 太陽光線の回転
                        modalScene.children.forEach(child => {
                            if (child.geometry && child.geometry.type === 'CylinderGeometry') {
                                child.rotation.z += 0.01;
                            }
                        });
                    } else {
                        modalPlanet.rotation.y += 0.01;
                    }
                    
                    // カメラの微妙な動き
                    modalCamera.position.x = Math.sin(time * 0.5) * 0.5;
                    modalCamera.position.y = 1 + Math.cos(time * 0.3) * 0.2;
                    modalCamera.lookAt(modalScene.position);
                    
                    modalRenderer.render(modalScene, modalCamera);
                } else {
                    if (modalAnimationId) {
                        cancelAnimationFrame(modalAnimationId);
                    }
                }
            }
            animateModal();
        }
        
        function addModalStarfield() {
            if (!modalScene) return;
            
            // モーダル用の小さな星空を作成
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({ 
                color: 0xffffff, 
                size: 1,
                sizeAttenuation: false,
                transparent: true,
                opacity: 0.6
            });

            const starsVertices = [];
            for (let i = 0; i < 200; i++) {
                const x = (Math.random() - 0.5) * 50;
                const y = (Math.random() - 0.5) * 50;
                const z = (Math.random() - 0.5) * 50;
                starsVertices.push(x, y, z);
            }

            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            modalScene.add(stars);
            
            // キラキラ星も追加
            const colors = [0xffffff, 0x88ddff, 0xffaa44, 0xff6666, 0x66ff88];
            for (let i = 0; i < 20; i++) {
                const geometry = new THREE.SphereGeometry(0.05, 8, 8);
                const color = colors[Math.floor(Math.random() * colors.length)];
                const material = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.6
                });
                
                const star = new THREE.Mesh(geometry, material);
                star.position.set(
                    (Math.random() - 0.5) * 40,
                    (Math.random() - 0.5) * 40,
                    (Math.random() - 0.5) * 40
                );
                
                modalScene.add(star);
            }
        }
        
        function create3DModelFallback(bodyData) {
            // モーダル用の3Dシーンを作成
            modalScene = new THREE.Scene();
            modalCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            modalRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            modalRenderer.setSize(250, 250);
            modalRenderer.setClearColor(0x000011, 1);
            modal3DContainer.appendChild(modalRenderer.domElement);
            
            // 天体の3Dモデルを作成
            const geometry = new THREE.SphereGeometry(2, 32, 32);
            let material;
            
            if (bodyData.name === '太陽') {
                material = new THREE.MeshBasicMaterial({ 
                    color: bodyData.color,
                    transparent: true
                });
                
                // 太陽の発光エフェクト
                const glowGeometry = new THREE.SphereGeometry(2.5, 32, 32);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffff00,
                    transparent: true,
                    opacity: 0.3
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                modalScene.add(glow);
            } else {
                material = new THREE.MeshBasicMaterial({ 
                    color: bodyData.color,
                    transparent: true
                });
            }
            
            const modalPlanet = new THREE.Mesh(geometry, material);
            modalScene.add(modalPlanet);
            
            // 土星の場合はリングを追加
            if (bodyData.name === '土星') {
                const ringGeometry = new THREE.RingGeometry(3, 4.5, 32);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0xcccccc,
                    transparent: true,
                    opacity: 0.6,
                    side: THREE.DoubleSide
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                modalPlanet.add(ring);
            }
            
            // カメラの位置設定
            modalCamera.position.set(0, 1, 5);
            modalCamera.lookAt(modalScene.position);
            
            // アニメーションループ
            function animateModal() {
                if (modal.style.display === 'block') {
                    requestAnimationFrame(animateModal);
                    modalPlanet.rotation.y += 0.02;
                    modalRenderer.render(modalScene, modalCamera);
                }
            }
            animateModal();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.001;
            
            // 動的な星のキラキラエフェクト
            twinklingStars.forEach((star) => {
                const userData = star.userData;
                
                // ランダムな強度変化
                const twinkle = Math.sin(time * userData.twinkleSpeed + userData.twinkleOffset) * userData.intensityVariation + 0.5;
                const pulse = Math.sin(time * userData.pulseSpeed + userData.twinkleOffset * 2) * 0.3 + 0.7;
                
                // 光量をランダムに変化
                star.material.opacity = twinkle * pulse;
                
                // 色の輝度もランダムに変化
                const brightness = (twinkle + pulse) / 2;
                const color = new THREE.Color(userData.baseColor);
                color.multiplyScalar(brightness + 0.3);
                star.material.color = color;
                
                // サイズも微妙に変化
                const sizeVariation = 1 + (twinkle - 0.5) * 0.3;
                star.scale.setScalar(sizeVariation);
            });
            
            // 天体の回転アニメーション
            celestialObjects.forEach((obj) => {
                if (obj.userData.name === '太陽') {
                    obj.rotation.y += 0.005;
                    // 太陽の光線も回転
                    obj.children.forEach(child => {
                        if (child.geometry && child.geometry.type === 'CylinderGeometry') {
                            child.rotation.z += 0.01;
                        }
                    });
                } else if (obj.userData.name && obj.userData.distance !== undefined) {
                    obj.rotation.y += 0.01;
                    // 軌道運動
                    const distance = obj.userData.distance;
                    if (distance > 0 && obj.userData.name !== '月') {
                        obj.position.x = Math.cos(time * 0.1 * (1 / Math.sqrt(distance))) * distance;
                        obj.position.z = Math.sin(time * 0.1 * (1 / Math.sqrt(distance))) * distance;
                    } else if (obj.userData.name === '月') {
                        // 月は地球の周りを回る
                        const earth = celestialObjects.find(o => o.userData.name === '地球');
                        if (earth) {
                            obj.position.x = earth.position.x + Math.cos(time * 2) * 5;
                            obj.position.z = earth.position.z + Math.sin(time * 2) * 5;
                        }
                    }
                }
            });
            
            // カメラを常に中心を向かせる
            camera.lookAt(scene.position);
            
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>